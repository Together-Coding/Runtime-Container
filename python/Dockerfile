FROM ubuntu:22.04 as intermediate
# Ref: https://vsupalov.com/build-docker-image-clone-private-repo-ssh-key/

RUN apt-get update
RUN apt-get install git -y

# Add credentials on build
ARG SSH_PRIVATE_KEY
RUN mkdir /root/.ssh/
RUN echo "${SSH_PRIVATE_KEY}" > /root/.ssh/id_ed25519
RUN chmod 400 /root/.ssh/id_ed25519

# Make sure your domain is accepted
RUN touch /root/.ssh/known_hosts
RUN ssh-keyscan github.com >> /root/.ssh/known_hosts

RUN mkdir -p /runtime-agent
WORKDIR /runtime-agent
RUN git init
RUN git remote add origin git@github.com:Together-Coding/runtime-agent.git

# Modify the commit hash on demand
RUN git fetch origin 72bb15fb1a5fd74d843d69cb7eccaf13d8dfd59c
RUN git reset --hard FETCH_HEAD


FROM python:3.10.4-bullseye

# When building this in Korea, Change APT data sources because the default ones are really slow in most cases.
RUN cd /etc/apt && sed -i 's/archive.ubuntu.com/ftp.daum.net/g' sources.list

# Install requirements to run services and agent server
RUN apt-get update && apt-get upgrade -y
RUN apt-get install python3-pip python3-dev -y
RUN apt-get install openssh-server -y

# Confiture user `together`
RUN useradd -ms /bin/bash together
# Password will be regenerated by the Runtime-Agent server.
# RUN echo 'together:LORIO}pNs+oZ01wNF=BQFXycQG' | chpasswd

# Make user environments
RUN mkdir -p /usr/src/app

# Install Runtime-Agent
RUN mkdir -p /usr/src/agent
WORKDIR /usr/src/agent
COPY --from=intermediate /runtime-agent/requirements.txt /usr/src/agent/
RUN pip3 install --no-cache-dir -r requirements.txt
COPY --from=intermediate /runtime-agent/. /usr/src/agent/

# Restrict user's permission
RUN chown -R together:together /usr/src/app
RUN chmod -R 700 /usr/src/agent

# Configure SSH server
# XXX: add more security related configurations.

# Because public IP is used directly, 8000 port is used and we don't need to expose any port.
CMD service ssh start \
    && uvicorn agent:app --host 0.0.0.0 --port 8000
