# Ref: https://vsupalov.com/build-docker-image-clone-private-repo-ssh-key/
FROM ubuntu:22.04 as intermediate

RUN apt-get update
RUN apt-get install git -y

# Add credentials on build
ARG SSH_PRIVATE_KEY
RUN mkdir /root/.ssh/
RUN echo "${SSH_PRIVATE_KEY}" > /root/.ssh/id_ed25519
RUN chmod 400 /root/.ssh/id_ed25519

# Make sure your domain is accepted
RUN touch /root/.ssh/known_hosts
RUN ssh-keyscan github.com >> /root/.ssh/known_hosts

RUN mkdir -p /runtime-agent
WORKDIR /runtime-agent
RUN git init
RUN git remote add origin git@github.com:Together-Coding/runtime-agent.git
RUN git fetch origin 412cb56a0b9b00609c1170c7fd822cdc8ab0cb1a
RUN git reset --hard FETCH_HEAD

FROM gcc:11
# python 3.9.2

RUN cd /etc/apt && sed -i 's/archive.ubuntu.com/ftp.daum.net/g' sources.list

# Install requirements to run services and agent server
RUN apt-get update && apt-get upgrade -y
RUN apt-get install python3-pip python3-dev -y
RUN apt-get install openssh-server -y

# Confiture user `together`
RUN useradd -ms /bin/bash together
# Password will be regenerated by the Runtime-Agent server.
# RUN echo 'together:LORIO}pNs+oZ01wNF=BQFXycQG' | chpasswd

# Make user environments
RUN mkdir -p /usr/src/app

# Restrict user's permission
RUN chown -R together:together /usr/src/app

# Configure SSH server
# TODO: add more security related configures

# Install Runtime-Agent
RUN mkdir -p /usr/src/agent
WORKDIR /usr/src/agent
COPY --from=intermediate /runtime-agent/requirements.txt /usr/src/agent/
RUN pip3 install --no-cache-dir -r requirements.txt
COPY --from=intermediate /runtime-agent/. /usr/src/agent/

# EXPOSE 22  # ssh is connected through localhost
# EXPOSE 8989  # public IP is used directly, so 8000 port is used.
CMD service ssh start \
    && uvicorn agent:app --host 0.0.0.0 --port 8000
