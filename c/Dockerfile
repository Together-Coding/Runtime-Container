FROM gcc:11

RUN cd /etc/apt && sed -i 's/archive.ubuntu.com/ftp.daum.net/g' sources.list

RUN apt-get update
RUN apt-get install -y python3.10 python3-pip python3-dev
RUN apt-get install -y openssh-server
EXPOSE 22

# Make user environments
RUN mkdir -p /usr/src/app && mkdir -p /usr/src/agent

# Install Runtime-Agent
WORKDIR /usr/src/agent
COPY runtime-agent/requirements.txt /usr/src/agent/
RUN pip3 install --no-cache-dir -r requirements.txt
EXPOSE 8989

# FIXME: Download runtime-agent from github. Before that, build dockerfile at `../../runtime-container/../`
COPY runtime-agent/. /usr/src/agent/

# Confiture user `together`
# Password will be regenerated by the Runtime-Agent server.
RUN useradd -ms /bin/bash together 
RUN echo 'together:LORIO}pNs+oZ01wNF=BQFXycQG' | chpasswd

# Restrict user's permission
RUN chown -R together:together /usr/src/app

# Configure SSH server
# TODO: add more security related configures

CMD service ssh start && python3 agent.py
